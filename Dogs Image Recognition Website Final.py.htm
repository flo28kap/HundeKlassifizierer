#!/usr/bin/env python
# coding: utf-8

# In[1]:


#hide
# !pip install -Uqq fastbook
import fastbook
fastbook.setup_book()


# In[2]:


#hide
from fastbook import *
from fastai.vision.widgets import *
from fastai.vision.all import *
from jmd_imagescraper.core import * 
from pathlib import Path
from jmd_imagescraper.imagecleaner import *


# In[ ]:


import urllib.request

MODEL_URL = "https://nextcloud.kapp.es/s/rqMAwEPnjXML2Ej/download"
urllib.request.urlretrieve(MODEL_URL, "model.pkl")

learn_inf = load_learner("model.pkl", cpu=True)


# In[ ]:


btn_upload = widgets.FileUpload()
btn_run = widgets.Button(description='Classify')
out_pl = widgets.Output()
lbl_pred = widgets.Label()


# In[ ]:


def on_click_classify(change):
    img = PILImage.create(btn_upload.data[-1])
    out_pl.clear_output()
    with out_pl: display(img.to_thumb(128,128))
    pred,pred_idx,probs = learn_inf.predict(img)
    lbl_pred.value = f'Vorhersage: {pred}; Wahrscheinlichkeit: {probs[pred_idx]:.04f}'

btn_run.on_click(on_click_classify)


# ## Hundeklassifizierer

# In[ ]:


VBox([widgets.Label("Lade deinen Hund hoch:"), 
      btn_upload, btn_run, out_pl, lbl_pred])

